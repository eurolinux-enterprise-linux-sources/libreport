From 1990486f7a8f9d364a6dbd9c1862d931a398cd0d Mon Sep 17 00:00:00 2001
From: Jiri Moskovcak <jmoskovc@redhat.com>
Date: Sat, 11 May 2013 16:36:48 +0200
Subject: [RHEL6 LIBREPORT PATCH 94/94] create last_occurrence at the time of
 the first crash - rhbz#961231

- closes #161

Signed-off-by: Jiri Moskovcak <jmoskovc@redhat.com>
Signed-off-by: Richard Marko <rmarko@fedoraproject.org>
Signed-off-by: Jakub Filak <jfilak@redhat.com>
---
 src/lib/dump_dir.c | 15 ++++++++++++---
 1 file changed, 12 insertions(+), 3 deletions(-)

diff --git a/src/lib/dump_dir.c b/src/lib/dump_dir.c
index ce31cc0..f2e7376 100644
--- a/src/lib/dump_dir.c
+++ b/src/lib/dump_dir.c
@@ -463,9 +463,18 @@ void dd_create_basic_files(struct dump_dir *dd, uid_t uid, const char *chroot_di
 {
     char long_str[sizeof(long) * 3 + 2];
 
-    time_t t = time(NULL);
-    sprintf(long_str, "%lu", (long)t);
-    dd_save_text(dd, FILENAME_TIME, long_str);
+    char *time_str = dd_load_text_ext(dd, FILENAME_TIME,
+                    DD_FAIL_QUIETLY_ENOENT | DD_LOAD_TEXT_RETURN_NULL_ON_FAILURE);
+    if (!time_str)
+    {
+        time_t t = time(NULL);
+        sprintf(long_str, "%lu", (long)t);
+        /* first occurrence */
+        dd_save_text(dd, FILENAME_TIME, long_str);
+        /* last occurrence */
+        dd_save_text(dd, FILENAME_LAST_OCCURRENCE, long_str);
+    }
+    free(time_str);
 
     /* it doesn't make sense to create the uid file if uid == -1 */
     if (uid != (uid_t)-1L)
-- 
1.8.2.1

