From 1ee8b2e09cd02db838a601b81524de8cb18f86a6 Mon Sep 17 00:00:00 2001
From: Denys Vlasenko <vda.linux@googlemail.com>
Date: Thu, 17 May 2012 13:55:35 +0200
Subject: [PATCH 27/53] iso_date_string: make sure year is between 0000 and
 9999

Signed-off-by: Denys Vlasenko <vda.linux@googlemail.com>
---
 src/lib/iso_date_string.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/src/lib/iso_date_string.c b/src/lib/iso_date_string.c
index 2db0d29..a7fb867 100644
--- a/src/lib/iso_date_string.c
+++ b/src/lib/iso_date_string.c
@@ -25,6 +25,14 @@ char *iso_date_string(const time_t *pt)
 
     time_t t;
     struct tm *ptm = localtime(pt ? pt : (time(&t), &t));
+
+    /* Callers expect that %Y is four digits, and size buffers accordingly.
+     * For paranoid reasons, disallow insane years which can overflow
+     * string buffers.
+     */
+    if (ptm->tm_year+1900 < 0 || ptm->tm_year+1900 > 9999)
+        error_msg_and_die("Year=%d?? Aborting", ptm->tm_year+1900);
+
     strftime(buf, sizeof(buf), "%Y-%m-%d-%H:%M:%S", ptm);
 
     return buf;
-- 
1.7.11.2

