From e1a33444e2e7614817b2e08c726a99298e684d49 Mon Sep 17 00:00:00 2001
From: Jiri Moskovcak <jmoskovc@redhat.com>
Date: Fri, 16 Aug 2013 13:42:29 +0200
Subject: [LIBREPORT PATCH 108/111] do not leak file rhbz#997871

Signed-off-by: Jiri Moskovcak <jmoskovc@redhat.com>
Signed-off-by: Jakub Filak <jfilak@redhat.com>
Signed-off-by: Richard Marko <rmarko@redhat.org>
---
 src/plugins/reporter-rhtsupport.c | 18 +++++++++++-------
 1 file changed, 11 insertions(+), 7 deletions(-)

diff --git a/src/plugins/reporter-rhtsupport.c b/src/plugins/reporter-rhtsupport.c
index 7aba6eb..31f205d 100644
--- a/src/plugins/reporter-rhtsupport.c
+++ b/src/plugins/reporter-rhtsupport.c
@@ -40,6 +40,7 @@ static
 int create_tarball(const char *tempfile, problem_data_t *problem_data)
 {
     reportfile_t *file = NULL;
+    int retval = 0; /* everything is ok so far .. */
 
     int pipe_from_parent_to_child[2];
     xpipe(pipe_from_parent_to_child);
@@ -59,7 +60,7 @@ int create_tarball(const char *tempfile, problem_data_t *problem_data)
     if (tar_fdopen(&tar, pipe_from_parent_to_child[1], (char*)tempfile,
                 /*fileops:(standard)*/ NULL, O_WRONLY | O_CREAT, 0644, TAR_GNU) != 0)
     {
-        goto ret;
+        goto ret_fail;
     }
 
     file = new_reportfile();
@@ -91,7 +92,7 @@ int create_tarball(const char *tempfile, problem_data_t *problem_data)
                 if (tar_append_file(tar, (char*)content, xml_name) != 0)
                 {
                     free(xml_name);
-                    goto ret;
+                    goto ret_fail;
                 }
                 free(xml_name);
             }
@@ -127,7 +128,7 @@ int create_tarball(const char *tempfile, problem_data_t *problem_data)
          || tar_close(tar) != 0
         ) {
             free(block);
-            goto ret;
+            goto ret_fail;
         }
         tar = NULL;
         free(block);
@@ -142,11 +143,12 @@ int create_tarball(const char *tempfile, problem_data_t *problem_data)
         /* Hopefully, by this time child emitted more meaningful
          * error message. But just in case it didn't:
          */
-        goto ret;
+        goto ret_fail;
     }
-    return 0; /* success */
+    goto ret_clean; /* success */
 
- ret:
+ret_fail:
+    retval = 1; /* failure */
     /* We must close write fd first, or else child will wait forever */
     if (tar)
         tar_close(tar);
@@ -160,8 +162,10 @@ int create_tarball(const char *tempfile, problem_data_t *problem_data)
         safe_waitpid(child, NULL, 0);
     }
 
+ret_clean:
+    /* now it's safe to free file */
     free_reportfile(file);
-    return 1; /* failure */
+    return retval;
 }
 
 static
-- 
1.8.3.1

